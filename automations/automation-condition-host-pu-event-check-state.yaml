APIVersion: 1
label: automation:condition:host_pu_event_check_state
identities:
- automationcondition
data:
  automationconditions:
  - key: '@condition:host_pu_event_check_state'
    name: When a host PU event triggers
    propagate: true
    description: Continue if the host PU is created or archived.
    function: |-
      function when(m, params) {
        if (!params.eventPayload) {
          throw 'This condition must be configured with a trigger of type "Event"';
        }
        if (!params.pu_state) {
          throw 'Parameter "pu_state" must be set';
        }
        if (!params.platform_url) {
          throw 'Parameter "platform_url" must be set';
        }

        var eventType = params.eventPayload.type;
        var id = params.eventPayload.entity.ID;
        var namespace = params.eventPayload.entity.namespace;
        var archived = params.eventPayload.entity.archived;
        var state;

        if (params.eventPayload.entity.type !== "Host") {
          return { continue: false };
        }

        switch (eventType) {
          case "create":
            if (params.pu_state === "Archived") {
              return { continue: false };
            }

            state = "Created";
            break;
          case "update":
            if (params.pu_state === "Created") {
              return { continue: false };
            }

            if (!archived) {
              return { continue: false };
            }

            state = "Archived";
            break;
          case "delete":
            if (params.pu_state === "Created") {
              return { continue: false };
            }

            state = "Deleted";
            break;
        }

        return {
          continue: true,
          payload: {
            content: "\n\nAffected Processing Unit: " + id +
              "\nNamespace: " + namespace +
              "\n\nState:" + state
          }
        }
      }
    steps:
    - name: Parameters
      parameters:
      - name: Host PU State
        key: pu_state
        description: The state(s) to track for host Processing Units.
        type: Enum
        allowedChoices:
          Created: A host PU is created
          Archived: A host PU is archived
          Both: An host PU is created or archived
      - name: Platform URL
        key: platform_url
        description: The base URL to the platform's UI.
        type: String
