APIVersion: 1
label: recipe:policy-suggest:inter-namespace
data:
  recipes:
    - name: Create Inter-Namespace Policy
      description: Creates an inter-namespace ruleset policy for inter-traffic.
      label: recipe:policy-suggest:inter-namespace
      metadata:
        - "@aporeto:author=aporeto"
      associatedTags:
        - "aporeto:recipe:placement=policy-suggest"
        - "aporeto:recipe:placement=inter-namespace"
      deploymentMode: Unrestricted
      targetIdentities:
        - networkrulesetpolicy
      propagate: true
      longDescription: |-
        ### Create Inter-namespace policy

        This recipe will create a Network Ruleset Policy in each namespace to
        allow traffic between two defined namespaces.

      template: |-
        {{`
        APIVersion: 1
        data:
          networkrulesetpolicies:
          - name: inter-namespace-first
            description: "Ruleset automatically created by an Out of Box template."
            protected: true
            propagate: true
            namespace: {{ .Values.namespace1Path }}
            incomingRules:
            - action: Allow
              object:
              - - '$identity=processingunit'
              {{- range _, $tag := .Values.namespace2Tags }}
                - {{ $tag | quote }}
              {{- end }}
              protocolPorts:
              - any
            outgoingRules:
            - action: Allow
              object:
              - - '$identity=processingunit'
              {{- range _, $tag := .Values.namespace2Tags }}
                - {{ $tag | quote }}
              {{- end }}
              protocolPorts:
              - any
            subject:
            {{- range $index, $tag := .Values.namespace1Tags }}
            {{- if eq $index 0 }}
            - - {{ $tag | quote }}
            {{- else }}
              - {{ $tag | quote }}
            {{- end }}
            {{- end }}
          - name: inter-namespace-second
            description: "Ruleset automatically created by an Out of Box template."
            protected: true
            propagate: true
            namespace: {{ .Values.namespace2Path }}
            incomingRules:
            - action: Allow
              object:
              - - '$identity=processingunit'
              {{- range _, $tag := .Values.namespace1Tags }}
                - {{ $tag | quote }}
              {{- end }}
              protocolPorts:
              - any
            outgoingRules:
            - action: Allow
              object:
              - - '$identity=processingunit'
              {{- range _, $tag := .Values.namespace1Tags }}
                - {{ $tag | quote }}
              {{- end }}
              protocolPorts:
              - any
            subject:
            {{- range $index, $tag := .Values.namespace2Tags }}
            {{- if eq $index 0 }}
            - - {{ $tag | quote }}
            {{- else }}
              - {{ $tag | quote }}
            {{- end }}
            {{- end }}
          `}}

      steps:
        - name: General
          description: General configuration
          parameters:
            - key: namespace1Path
              name: First namespace full path
              description: The full path to the first namespace.
              longDescription: |-
                Provide the fully qualified path to the first namespace. Example /tenant/cloudaccount/group/kube1
              type: String

            - key: namespace1Tags
              name: First namespace organizational metadata
              description: Organizational metadata denoting the first namespace.
              longDescription: |-
                Provide the organizational metdata tag(s) that will point to the first namespace. Example @org:cloudaccount=demo-cloud-account, @org:kubernetes=bookinfo
              type: StringSlice

            - key: namespace2Path
              name: Second namespace full path
              description: The full path to the second namespace.
              longDescription: |-
                Provide the fully qualified path to the second namespace. Example /tenant/cloudaccount/group/kube2
              type: String

            - key: namespace2Tags
              name: Second namespace organizational metadata
              description: Organizational metadata denoting the second namespace.
              longDescription: |-
                Provide the organizational metdata tag(s) that will point to the second namespace. Example @org:cloudaccount=demo-cloud-account, @org:kubernetes=boutique
              type: StringSlice
