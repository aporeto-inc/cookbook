
APIVersion: 1
label: recipe:quickstart:k8s
data:
  recipes:
  - name: Secure a Kubernetes Cluster
    label: recipe:quickstart:k8s
    options:
      appCrendentialFormat: YAML
    propagate: true
    metadata:
    - "@aporeto:audience=public"
    associatedTags:
    - "aporeto:placement=topnav"
    targetIdentities:
    - namespace
    - appcredential
    - enforcerprofile
    - enforcerprofilemappingpolicy
    - automation
    description: Secure a Kubernetes cluster with Aporeto Enforcerd and Operator.
    longDescription: |-

      ### Secure your Kubernetes cluster with Aporeto

      Follow these steps to onboard an enforcerd in your Kubernetes cluster.

      #### Prerequisites

      Before diving into the steps, make sure you have

      - [Create the Tiller service account](https://docs.aporeto.com/docs/main/k8s-install/k8s-quickstart/#1-create-the-tiller-service-account)
      - [Initialize Helm and deploy Tiller](https://docs.aporeto.com/docs/main/k8s-install/k8s-quickstart/#2-initialize-helm-and-deploy-tiller)
      - [Add Aporeto to Helm repository](https://docs.aporeto.com/docs/main/k8s-install/k8s-quickstart/#3-add-the-aporeto-repository-to-helm)

      You can use steps 1 and 2 from the [official documentation page](https://docs.aporeto.com/docs/main/k8s-install/k8s-quickstart/) for that.

      #### Summary

      1. Define a Namespace that will store all your data in a single folder-like structure.

        _(See all namespaces from the left menu under "Namespace Settings")_

      2. Create two AppCredentials
          - One will be given to the **enforcerd** to register and communicate with the Aporeto control plane.
          - One will be given to the **Aporeto Operator** which provides a bridge between Aporeto APIs and Kubernetes API using CRDs (Custom Resource Definitions).

        _(See all "AppCredentials" from the left menu under "Namespace Settings")_

      3. Install the Aporeto Operator using helm

      4. Install the enforcerd using helm

    template: |-
      {{`
      APIVersion: 1
      data:
        namespaces:
        - name: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
          {{- if .Values.namespace_description }}
          description: {{ .Values.namespace_description }}
          {{- end }}
        enforcerprofiles:
        - name: kubernetes-default
          namespace: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
          protected: true
          metadata:
          - '@profile:name=kubernetes-default'
          description: Default Profile for Kubernetes
          excludedNetworks:
          - 127.0.0.0/8
          ignoreExpression:
          - - '@app:k8s:namespace=aporeto'
          - - '@app:k8s:namespace=aporeto-operator'
          - - '@app:k8s:namespace=kube-system'
          excludedInterfaces: []
          targetNetworks: []
          targetUDPNetworks: []
        enforcerprofilemappingpolicies:
        - name: fallback-kubernetes-default
          namespace: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
          protected: true
          fallback: true
          description: "Kubernetes fallback: if there is no other profile, use the default Kubernetes profile."
          object:
          - - '@profile:name=kubernetes-default'
          subject:
          - - $identity=enforcer
        appcredentials:
        - name: "enforcerd"
          namespace: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
          description: "credentials used by the enforcerd running in kubernetes."
          roles:
          - "@auth:role=enforcer"
        - name: "aporeto-operator"
          namespace: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
          description: "credentials used by the aporeto-operator."
          roles:
          - "@auth:role=aporeto-operator"
        automations:
          - name: install-default-allow-all-policies
            namespace: {{ required ".Values.namespace_name is required" .Values.namespace_name }}
            description: Installs default allow all fallback policies for every child namespace that gets created to mimic Kubernetes default behavior.
            trigger: Event
            events:
              namespace:
                - create
            entitlements:
              externalnetwork:
                - create
              networkaccesspolicy:
                - create
            condition: |-
              function when(api, params) {
                  // Your custom code goes here.
                  return {continue: true, payload: { namespace: params.eventPayload.entity }};
              }
            actions:
              - |-
                /**
                 * Write your action code here. This function will be executed when the condition is met
                 * @param {object} api - api manipulator that allows CRUD operations.
                 * @param {object} params - the parameters configured in the automation.
                 * @param {object} payload - Payload returned by the condition.
                 */
                function then(api, params, payload) {
                    api.Create('externalnetwork', {
                        name: 'external-tcp-all',
                        description: 'Created by an automation on namespace creation. It is safe to be deleted, if not required.',
                        metadata: ['@ext:name=tcpall'],
                        entries: ['0.0.0.0/0'],
                        ports: ['1:65535'],
                        protocols: ['tcp'],
                        propagate: true,
                    }, payload.namespace.name);
                    api.Create('externalnetwork', {
                        name: 'external-udp-all',
                        description: 'Created by an automation on namespace creation. It is safe to be deleted, if not required.',
                        metadata: ['@ext:name=udpall'],
                        entries: ['0.0.0.0/0'],
                        ports: ['1:65535'],
                        protocols: ['udp'],
                        propagate: true,
                    }, payload.namespace.name);
                    api.Create('networkaccesspolicy', {
                        name: 'default-fallback-ingress-allow-all',
                        description: 'Created by an automation on namespace creation. It is safe to be deleted, if not required.',
                        metadata: ['@netpol=default-fallback'],
                        propagate: true,
                        fallback: true,
                        logsEnabled: true,
                        observationEnabled: true,
                        observedTrafficAction: 'Apply',
                        action: 'Allow',
                        applyPolicyMode: 'IncomingTraffic',
                        subject: [
                            ['$identity=processingunit'],
                            ['@ext:name=tcpall'],
                            ['@ext:name=udpall'],
                        ],
                        object: [['$namespace='+payload.namespace.name]],
                    }, payload.namespace.name);
                    api.Create('networkaccesspolicy', {
                        name: 'default-fallback-egress-allow-all',
                        description: 'Created by an automation on namespace creation. It is safe to be deleted, if not required',
                        metadata: ['@netpol=default-fallback'],
                        propagate: true,
                        fallback: true,
                        logsEnabled: true,
                        observationEnabled: true,
                        observedTrafficAction: 'Apply',
                        action: 'Allow',
                        applyPolicyMode: 'OutgoingTraffic',
                        subject: [['$namespace='+payload.namespace.name]],
                        object: [
                            ['$identity=processingunit'],
                            ['@ext:name=tcpall'],
                            ['@ext:name=udpall'],
                        ],
                    }, payload.namespace.name);
                }
      `}}

    steps:

    - name: Namespace
      description: |-
        Let's create a namespace first. It will contain all the data that will be created during these steps.

        ##### Read more about Namespaces and Authentication

        - [Namespaces](https://docs.aporeto.com/docs/main/concepts/namespaces/)
        - [Authentications and authorizations](https://docs.aporeto.com/docs/main/concepts/authentication-and-authorization/)

      parameters:
      - key: namespace_name
        name: Namespace
        description: Define your namespace name.
        type: String
        defaultValue: mycluster

      - key: namespace_description
        name: Description
        description: Description of the namespace.
        type: String
        optional: true

    successfullMessage: |-

        #### Create a kubernetes namespace to deploy Aporeto

        ```shell
        kubectl create namespace aporeto-operator
        kubectl create namespace aporeto
        ```

        #### Install the secrets

        A zip file has been dowloaded to your computer. it contains application credentials
        that will be used to authenticate your cluster with Aporeto. Unzip the
        archive, then run:

        ```shell
        kubectl apply -n aporeto-operator -f aporeto-operator.yaml
        ```

        ```shell
        kubectl apply -n aporeto -f enforcerd.yaml
        ```

        #### Install Aporeto Operator

        Install Aporeto CRDs in your cluster:

        ```shell
        helm install aporeto/aporeto-crds --name aporeto-crds
        ```

        Deploy Aporeto Operator:

        ```shell
        helm install aporeto/aporeto-operator --name aporeto-operator --namespace aporeto-operator
        ```

        #### Install Enforcerd

        Install enforcerd:

        ```shell
        helm install aporeto/enforcerd --name enforcerd --namespace aporeto
        ```
