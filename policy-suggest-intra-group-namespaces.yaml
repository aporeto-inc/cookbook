APIVersion: 1
label: recipe:policy-suggest:auto-secure_intra-vm_groups
data:
  recipes:
    - name: Auto-Secure Intra-VM Groups
      description: Creates a Network Ruleset Policy to allow Group namespace traffic.
      label: recipe:policy-suggest:auto-secure_intra-vm_groups
      metadata:
        - "@aporeto:author=aporeto"
      associatedTags:
        - "aporeto:recipe:placement=policy-suggest"
        - "aporeto:recipe:placement=intra-namespace"
        - "aporeto:recipe:placement=group-level"
      deploymentMode: NamespaceUnique
      targetIdentities:
        - networkrulesetpolicy
      propagate: true
      longDescription: |-
        ### Auto-secure intra-VM groups

        This recipe will create a Network Ruleset Policy to auto-secure
        a Group namespaces (third-level namespaces).

      template: |-
        {{`
        APIVersion: 1
        data:
          networkrulesetpolicies:
          - name: auto-secure_intra-vm_groups
            protected: true
            incomingRules:
            - action: Allow
              object:
              - - $identity=processingunit
              protocolPorts:
              - any
            outgoingRules:
            - action: Allow
              object:
              - - $identity=processingunit
              protocolPorts:
              - any
            subject:
            - {{- range $index, $orgmeta := .Aporeto.OrganizationalMetadata }}
              - {{ $orgmeta | quote }}
              {{- end }}
        `}}
