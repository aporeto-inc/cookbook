APIVersion: 1
label: recipe:automation-action:send-slack
data:
  recipes:
    - name: Create a Send Slack Automation Action
      description: Creates an automation action that posts to a specific Slack WebHook.
      label: recipe:automation-action:send-slack
      metadata:
        - "@aporeto:author=aporeto"
      associatedTags:
        - "aporeto:recipe:placement=automation-action"
      targetIdentities:
        - automationaction
      propagate: true
      longDescription: |-
        ### Create an automation action to post to a Slack WebHook

        This recipe will create an automation action that will send
        a provided message payload to a specified Slack WebHook.

      template: |-
        {{`
        APIVersion: 1
        data:
          automationactions:
          - key: "@action:send_slack_{{ .RenderID }}"
            name: Then send a message to the Slack webhook {{ .Values.url }}
            propagate: true
            description: Sends a message to Slack using {{ .Values.url }}.
            function: |-
              function then(m, params, payload) {
                if (!params.title) {
                    throw 'Parameter key "title" must be set';
                }
                if (!params.content) {
                    throw 'Parameter key "content" must be set';
                }

                var message = payload.content ? params.content + payload.content : params.content

                body = JSON.stringify({
                    text: params.title + "\n\n" + message,
                });

                aporeto.http(
                    'POST',
                    params.url,
                    body
                );
              }
            parameters:
              url: {{ .Values.url }}
            steps:
            - name: Parameters
              parameters:
              - name: Title
                key: title
                description: The title of the message to send
                type: String
              - name: Content
                key: content
                description: The content of the message to send
                type: String
              - key: url
                name: URL
                description: Incoming WebHook Slack Endpoint
                type: String
                defaultValue: {{ .Values.url }}
        `}}

      steps:
        - name: Parameters
          parameters:
            - key: url
              name: URL
              description: Incoming WebHook Slack Endpoint
              type: String
